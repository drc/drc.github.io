<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://dancigrang.dev//favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dancigrang.dev//favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dancigrang.dev//favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://dancigrang.dev//android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://dancigrang.dev//apple-touch-icon.png><meta name=description content><title>Setting Up Mid Server using Docker | Dan Cigrang
</title><link rel=canonical href=https://dancigrang.dev/posts/2022/setting-up-mid-server-docker/><meta property="og:url" content="https://dancigrang.dev/posts/2022/setting-up-mid-server-docker/"><meta property="og:site_name" content="Dan Cigrang"><meta property="og:title" content="Setting Up Mid Server using Docker"><meta property="og:description" content="Introduction Since the Rome release, ServiceNow provides a download of a MID Server configuration using a Docker container. To start, download the Docker config from the MID Server downloads page on the instance by going to MID Server > Downloads and clicking on the download link under Linux Docker Recipe.
User Interface for MID Server download Linux Docker Recipe download modal"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-01T16:29:35-05:00"><meta property="article:modified_time" content="2022-09-01T16:29:35-05:00"><meta property="article:tag" content="Servicenow"><meta property="article:tag" content="Docker"><link rel=stylesheet href=/assets/combined.min.14e1218b5e9a0404dee05846c1ffd60757d618f79d3897fdd4eea5f441a9a7af.css media=all></head><body class=auto><div class=content><header><div class=header><h1 class=header-title><a href=https://dancigrang.dev/>Dan Cigrang</a></h1><div class=flex><p class=small><a href=/>/Home</a></p><p class=small><a href=/categories>/Categories</a></p><p class=small><a href=/tags>/Tags</a></p><p class=small><a href=/about>/About</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/posts/>Posts</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/posts/2022/setting-up-mid-server-docker/>Setting Up Mid Server using Docker</a></div><div><div class=single-intro-container><h1 class=single-title>Setting Up Mid Server using Docker</h1><p class=single-readtime><time datetime=2022-09-01T16:29:35-05:00>September 1, 2022</time></p></div><div class=single-content><h2 id=introduction>Introduction</h2><p>Since the Rome release, ServiceNow provides a download of a MID Server configuration using a Docker container. To start, download the Docker config from the MID Server downloads page on the instance by going to <strong>MID Server > Downloads</strong> and clicking on the download link under <strong>Linux Docker Recipe</strong>.</p><p><figure><div><img loading=lazy alt="User Interface for MID Server Download" src=/images/Downloads.webp></div><div class=caption-container><figcaption>User Interface for MID Server download</figcaption></div></figure></p><p><figure><div><img loading=lazy alt="Linux Docker Recipe download modal" src=/images/recipe.webp></div><div class=caption-container><figcaption>Linux Docker Recipe download modal</figcaption></div></figure></p><p>Included in the download are some scripts and assets that are required to build the image. Since there are parameters that you need to include in the build and rather than providing a full image, the instance only needs to download text files of scripts and a <code>Dockerfile</code>. This option makes it a small download and keeps it efficient.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Permissions Size User Date Modified Name
</span></span><span style=display:flex><span>drwxrwxrwx     - dan  27 Jul 18:56  asset
</span></span><span style=display:flex><span>.rwxrwxrwx  3.6k dan  28 Jul 01:58  Dockerfile
</span></span><span style=display:flex><span>.rwxrwxrwx   70k dan  27 Jul 18:56  EULA - MID Server.pdf
</span></span><span style=display:flex><span>drwxrwxrwx     - dan   2 Sep 16:27  META-INF
</span></span><span style=display:flex><span>.rwxrwxrwx    43 dan  27 Jul 18:56  mid-secrets.properties
</span></span><span style=display:flex><span>.rwxrwxrwx   197 dan  27 Jul 18:56  mid.env
</span></span><span style=display:flex><span>.rwxrwxrwx  4.7M dan  27 Jul 18:56  ServiceNow Open Source Disclosure - MID Server.pdf
</span></span></code></pre></div><h2 id=configuring-the-dockerfile>Configuring the Dockerfile</h2><p>The <code>Dockerfile</code> includes the following steps:</p><ul><li>Download the MID Server zip file and validate the integrity of the file</li><li>Building and setting environment variables on a CentOS build including dependencies</li><li>Setting the username, User ID and Group ID and other permissions</li><li>Finally running the included <code>init</code> shell script with the start parameter</li></ul><p>I am running an Oracle Cloud Instance of ARM Ubuntu. After trying to set up this MID Server image, the current configuration of this <code>Dockerfile</code> will not work for me since I am on ARM architecture and the included JRE in the MID Server download is x86_64 architecture.</p><p>I first played around with updating the <code>Dockerfile</code> to use Amazon Corretto (Amazon&rsquo;s version of OpenJDK) image rather than CentOS. I know Amazon Corretto has a build of Java that will work with ARM, rather than using the packaged JRE from ServiceNow. This is an easy swap, because the <code>amazoncorreto</code> image is built off of an Alpine distribution, so using <code>yum</code> as the package manager makes it a direct swap.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span>...<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888;font-style:italic># ################</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888;font-style:italic># Final Stage (using the downloaded ZIP file from previous stage)</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888;font-style:italic># ################</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700;text-decoration:underline>FROM</span><span style=color:#666;font-style:italic> amazoncorretto</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700;text-decoration:underline>RUN</span> yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm<span>
</span></span></span><span style=display:flex><span><span></span>...<span>
</span></span></span></code></pre></div><h2 id=configuring-midenv>Configuring mid.env</h2><p>After updating the <code>Dockerfile</code>, I needed to update the <code>mid.env</code> file with all necessary parameters to connect to the instance.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_INSTANCE_URL</span>=https://devxxxxx.service-now.com/
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_INSTANCE_USERNAME</span>=mid.server
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_INSTANCE_PASSWORD</span>=******
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_SECRETS_FILE</span>=
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_SERVER_NAME</span>=oracle
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_PROXY_HOST</span>=
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_PROXY_PORT</span>=
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_PROXY_USERNAME</span>=
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_PROXY_PASSWORD</span>=
</span></span><span style=display:flex><span><span style=color:#666;font-weight:700;font-style:italic>MID_MUTUAL_AUTH_PEM_FILE</span>=
</span></span></code></pre></div><p>The important lines are only the url, username, and password. Everything else can be skipped unless you have a requirement like being behind a proxy or want to include mutual authentication using a certificate.</p><p>After setting this up, I kept running into an error where the process said it couldn&rsquo;t find a valid version of Java to run. I swear I had this version of Java that worked because I&rsquo;m using the amazoncorretto image! The image was still using the packaged version of java in the <code>agent/jre</code> directory. I know I could set a custom Java install in the <code>wrapper-override.conf</code> file after setting up a MID Server outside of Docker many times. Question is, how do I change the line in this file without starting an interactive terminal in my container?</p><p>In the <code>asset/init</code> bash script, there&rsquo;s a function called <code>updateWrapperConfFromEnvVars</code> that runs as part of the initial setup. This function also parses the <code>mid.env</code> file you include at runtime, looking for anything matching <code>MID_WRAPPER_&lt;wrapper config here></code>. Easy. All I had to add was <code>MID_WRAPPER_wrapper.java.command=/usr/bin/java</code> and the setup script will change this for me automatically.</p><h2 id=running-the-container>Running the Container</h2><p>Once the image was created, and the setup script runs through it&rsquo;s configuration of the <code>config.xml</code> file and <code>wrapper-override.conf</code> files, we&rsquo;re up and running with a MID Server in a Docker container!</p><p>While getting a feel for stopping, starting and restarting the container, I noticed that every time you start and stop the container, the instance detects that the keystore you generate when hitting Validate MID Server is missing, making your MID Server not validated. This makes sense, because there are no volumes mounted for the container, and it&rsquo;s a &ldquo;fresh&rdquo; image every restart. When using the amazoncorretto instance, I found ServiceNow is setting the keystore in <code>/usr/lib/jvm/java-1.8.0-amazon-corretto/jre/lib/security</code> directory. Knowing this, I copied the files out of here first to a local directory, and then started the container, using a flag to mount my local directory to the container. Now the image understands that it was once validated before and can startup again no problem without having to revalidate.</p><p>This is my final command to run after building the new mid_server image.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--env-file=mid.env <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>-v <span style=font-weight:700;text-decoration:underline>$(</span><span style=font-weight:700;font-style:italic>pwd</span><span style=font-weight:700;text-decoration:underline>)</span>/security:/usr/lib/jvm/java-1.8.0-amazon-corretto/jre/lib/security <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--name mid mid_server
</span></span></code></pre></div></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>Powered by
<a href=https://gohugo.io/>Hugo</a>
and
<a href=https://github.com/tomfran/typo>tomfran/typo</a></p></footer></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>
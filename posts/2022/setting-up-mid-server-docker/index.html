<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Setting Up Mid Server using Docker | Dan Cigrang</title><link rel=canonical href=https://dancigrang.dev/posts/2022/setting-up-mid-server-docker/><meta name=description content="Development and other notes"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Setting Up Mid Server using Docker"><meta property="og:description" content="Introduction Since the Rome release, ServiceNow provides a download of a MID Server configuration using a Docker container. To start, download the Docker config from the MID Server downloads page on the instance by going to MID Server > Downloads and clicking on the download link under Linux Docker Recipe.
Included in the download are some scripts and assets that are required to build the image. Since there are parameters that you need to include in the build and rather than providing a full image, the instance only needs to download text files of scripts and a Dockerfile."><meta property="og:type" content="article"><meta property="og:url" content="https://dancigrang.dev/posts/2022/setting-up-mid-server-docker/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-01T16:29:35-05:00"><meta property="article:modified_time" content="2022-09-01T16:29:35-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setting Up Mid Server using Docker"><meta name=twitter:description content="Introduction Since the Rome release, ServiceNow provides a download of a MID Server configuration using a Docker container. To start, download the Docker config from the MID Server downloads page on the instance by going to MID Server > Downloads and clicking on the download link under Linux Docker Recipe.
Included in the download are some scripts and assets that are required to build the image. Since there are parameters that you need to include in the build and rather than providing a full image, the instance only needs to download text files of scripts and a Dockerfile."><link rel=stylesheet href=https://dancigrang.dev/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://dancigrang.dev/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://dancigrang.dev/about/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&text=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&title=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&is_video=false&description=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Setting%20Up%20Mid%20Server%20using%20Docker&body=Check out this article: https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&title=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&title=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&name=Setting%20Up%20Mid%20Server%20using%20Docker&description=Introduction%20Since%20the%20Rome%20release%2c%20ServiceNow%20provides%20a%20download%20of%20a%20MID%20Server%20configuration%20using%20a%20Docker%20container.%20To%20start%2c%20download%20the%20Docker%20config%20from%20the%20MID%20Server%20downloads%20page%20on%20the%20instance%20by%20going%20to%20MID%20Server%20%26gt%3b%20Downloads%20and%20clicking%20on%20the%20download%20link%20under%20Linux%20Docker%20Recipe.%0aIncluded%20in%20the%20download%20are%20some%20scripts%20and%20assets%20that%20are%20required%20to%20build%20the%20image.%20Since%20there%20are%20parameters%20that%20you%20need%20to%20include%20in%20the%20build%20and%20rather%20than%20providing%20a%20full%20image%2c%20the%20instance%20only%20needs%20to%20download%20text%20files%20of%20scripts%20and%20a%20Dockerfile." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&t=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Setting Up Mid Server using Docker</h1><div class=meta><div class=postdate><time datetime="2022-09-01 16:29:35 -0500 -0500" itemprop=datePublished>2022-09-01</time></div><div class=article-read-time><i class="far fa-clock"></i>
4 minute read</div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/development>Development</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/servicenow rel=tag>servicenow</a>
,
<a class=tag-link href=/tags/docker rel=tag>docker</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#configuring-the-dockerfile>Configuring the Dockerfile</a></li><li><a href=#configuring-midenv>Configuring mid.env</a></li><li><a href=#running-the-container>Running the Container</a></li></ul></nav></div><div class=content itemprop=articleBody><h2 id=introduction>Introduction</h2><p>Since the Rome release, ServiceNow provides a download of a MID Server configuration using a Docker container. To start, download the Docker config from the MID Server downloads page on the instance by going to <strong>MID Server > Downloads</strong> and clicking on the download link under <strong>Linux Docker Recipe</strong>.</p><p><img src=./Downloads.png alt="User Interface for MID Server Download" title=Downloads></p><p><img src=./recipe.png alt="Linux Docker Recipe download modal"></p><p>Included in the download are some scripts and assets that are required to build the image. Since there are parameters that you need to include in the build and rather than providing a full image, the instance only needs to download text files of scripts and a <code>Dockerfile</code>. This option makes it a small download and keeps it efficient.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Permissions Size User Date Modified Name
</span></span><span style=display:flex><span>drwxrwxrwx     - dan  <span style=color:#d3869b>27</span> Jul 18:56  asset
</span></span><span style=display:flex><span>.rwxrwxrwx  3.6k dan  <span style=color:#d3869b>28</span> Jul 01:58  Dockerfile
</span></span><span style=display:flex><span>.rwxrwxrwx   70k dan  <span style=color:#d3869b>27</span> Jul 18:56  EULA - MID Server.pdf
</span></span><span style=display:flex><span>drwxrwxrwx     - dan   <span style=color:#d3869b>2</span> Sep 16:27  META-INF
</span></span><span style=display:flex><span>.rwxrwxrwx    <span style=color:#d3869b>43</span> dan  <span style=color:#d3869b>27</span> Jul 18:56  mid-secrets.properties
</span></span><span style=display:flex><span>.rwxrwxrwx   <span style=color:#d3869b>197</span> dan  <span style=color:#d3869b>27</span> Jul 18:56  mid.env
</span></span><span style=display:flex><span>.rwxrwxrwx  4.7M dan  <span style=color:#d3869b>27</span> Jul 18:56  ServiceNow Open Source Disclosure - MID Server.pdf
</span></span></code></pre></div><h2 id=configuring-the-dockerfile>Configuring the Dockerfile</h2><p>The <code>Dockerfile</code> includes the following steps:</p><ul><li>Download the MID Server zip file and validate the integrity of the file</li><li>Building and setting environment variables on a CentOS build including dependencies</li><li>Setting the username, User ID and Group ID and other permissions</li><li>Finally running the included <code>init</code> shell script with the start parameter</li></ul><p>I am running an Oracle Cloud Instance of ARM Ubuntu. After trying to set up this MID Server image, the current configuration of this <code>Dockerfile</code> will not work for me since I am on ARM architecture and the included JRE in the MID Server download is x86_64 architecture.</p><p>I first played around with updating the <code>Dockerfile</code> to use Amazon Corretto (Amazon&rsquo;s version of OpenJDK) image rather than CentOS. I know Amazon Corretto has a build of Java that will work with ARM, rather than using the packaged JRE from ServiceNow. This is an easy swap, because the <code>amazoncorreto</code> image is built off of an Alpine distribution, so using <code>yum</code> as the package manager makes it a direct swap.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># ################</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># Final Stage (using the downloaded ZIP file from previous stage)</span>
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># ################</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>FROM</span><span style=color:#b8bb26> amazoncorretto</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>RUN</span> yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=configuring-midenv>Configuring mid.env</h2><p>After updating the <code>Dockerfile</code>, I needed to update the <code>mid.env</code> file with all necessary parameters to connect to the instance.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span>MID_INSTANCE_URL<span style=color:#fe8019>=</span>https://devxxxxx.service-now.com/
</span></span><span style=display:flex><span>MID_INSTANCE_USERNAME<span style=color:#fe8019>=</span>mid.server
</span></span><span style=display:flex><span>MID_INSTANCE_PASSWORD<span style=color:#fe8019>=</span>******
</span></span><span style=display:flex><span>MID_SECRETS_FILE<span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>MID_SERVER_NAME<span style=color:#fe8019>=</span>oracle
</span></span><span style=display:flex><span>MID_PROXY_HOST<span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>MID_PROXY_PORT<span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>MID_PROXY_USERNAME<span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>MID_PROXY_PASSWORD<span style=color:#fe8019>=</span>
</span></span><span style=display:flex><span>MID_MUTUAL_AUTH_PEM_FILE<span style=color:#fe8019>=</span>
</span></span></code></pre></div><p>The important lines are only the url, username, and password. Everything else can be skipped unless you have a requirement like being behind a proxy or want to include mutual authentication using a certificate.</p><p>After setting this up, I kept running into an error where the process said it couldn&rsquo;t find a valid version of Java to run. I swear I had this version of Java that worked because I&rsquo;m using the amazoncorretto image! The image was still using the packaged version of java in the <code>agent/jre</code> directory. I know I could set a custom Java install in the <code>wrapper-override.conf</code> file after setting up a MID Server outside of Docker many times. Question is, how do I change the line in this file without starting an interactive terminal in my container?</p><p>In the <code>asset/init</code> bash script, there&rsquo;s a function called <code>updateWrapperConfFromEnvVars</code> that runs as part of the initial setup. This function also parses the <code>mid.env</code> file you include at runtime, looking for anything matching <code>MID_WRAPPER_&lt;wrapper config here></code>. Easy. All I had to add was <code>MID_WRAPPER_wrapper.java.command=/usr/bin/java</code> and the setup script will change this for me automatically.</p><h2 id=running-the-container>Running the Container</h2><p>Once the image was created, and the setup script runs through it&rsquo;s configuration of the <code>config.xml</code> file and <code>wrapper-override.conf</code> files, we&rsquo;re up and running with a MID Server in a Docker container!</p><p>While getting a feel for stopping, starting and restarting the container, I noticed that every time you start and stop the container, the instance detects that the keystore you generate when hitting Validate MID Server is missing, making your MID Server not validated. This makes sense, because there are no volumes mounted for the container, and it&rsquo;s a &ldquo;fresh&rdquo; image every restart. When using the amazoncorretto instance, I found ServiceNow is setting the keystore in <code>/usr/lib/jvm/java-1.8.0-amazon-corretto/jre/lib/security</code> directory. Knowing this, I copied the files out of here first to a local directory, and then started the container, using a flag to mount my local directory to the container. Now the image understands that it was once validated before and can startup again no problem without having to revalidate.</p><p>This is my final command to run after building the new mid_server image.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d <span style=color:#b8bb26>\
</span></span></span><span style=display:flex><span><span style=color:#b8bb26></span>--env-file<span style=color:#fe8019>=</span>mid.env <span style=color:#b8bb26>\
</span></span></span><span style=display:flex><span><span style=color:#b8bb26></span>-v <span style=color:#fe8019>$(</span><span style=color:#fabd2f>pwd</span><span style=color:#fe8019>)</span>/security:/usr/lib/jvm/java-1.8.0-amazon-corretto/jre/lib/security <span style=color:#b8bb26>\
</span></span></span><span style=display:flex><span><span style=color:#b8bb26></span>--name mid mid_server
</span></span></code></pre></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&text=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&title=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&is_video=false&description=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Setting%20Up%20Mid%20Server%20using%20Docker&body=Check out this article: https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&title=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&title=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&name=Setting%20Up%20Mid%20Server%20using%20Docker&description=Introduction%20Since%20the%20Rome%20release%2c%20ServiceNow%20provides%20a%20download%20of%20a%20MID%20Server%20configuration%20using%20a%20Docker%20container.%20To%20start%2c%20download%20the%20Docker%20config%20from%20the%20MID%20Server%20downloads%20page%20on%20the%20instance%20by%20going%20to%20MID%20Server%20%26gt%3b%20Downloads%20and%20clicking%20on%20the%20download%20link%20under%20Linux%20Docker%20Recipe.%0aIncluded%20in%20the%20download%20are%20some%20scripts%20and%20assets%20that%20are%20required%20to%20build%20the%20image.%20Since%20there%20are%20parameters%20that%20you%20need%20to%20include%20in%20the%20build%20and%20rather%20than%20providing%20a%20full%20image%2c%20the%20instance%20only%20needs%20to%20download%20text%20files%20of%20scripts%20and%20a%20Dockerfile." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdancigrang.dev%2fposts%2f2022%2fsetting-up-mid-server-docker%2f&t=Setting%20Up%20Mid%20Server%20using%20Docker" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 Dan Cigrang</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script></html>